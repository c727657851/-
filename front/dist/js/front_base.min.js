//分为4步

//1.新建一个类
//2.写类的方法
//3.写一个类的run方法 统一执行类方法
//4.实例化对象 执行run方法


//注意赋值this 你点击谁 谁就是this


//新建一个类
function Auth() {
    var self = this;
    self.maskWrapper = $('.mask-wrapper');
    self.scrollWrapper = $('.scroll-wrapper');
    self.smsCaptcha = $('.sms-captcha-btn');
}
//图形验证码的方法 用户点击 重新发送一次请求
Auth.prototype.ListenImageCaptchaEvent = function(){
    var self = this;
    var imageCaptcha = $('.img-captcha');
    imageCaptcha.click(function () {
        imageCaptcha.attr('src','/account/image_captcha/'+'?r='+Math.random())
    })
}


//控制显示和隐藏的方法
Auth.prototype.ListenshowHideEvent = function () {
    var self = this;
    var signinBtn = $('.signin-btn');
    var signupBtn = $('.signup-btn');
    var closeBtn = $('.close-btn');

    signinBtn.click(function () {
        self.showEvent();
    })

     signupBtn.click(function () {
        self.showEvent();
    })

    closeBtn.click(function () {
        self.hideEvent();
    })
}

//实现登录注册的切换方法
Auth.prototype.ListenSwitchEvent = function () {
    var self = this;
    var switcher= $('.switch');

    switcher.click(function () {
       //获取当前距离左边的位置
        var currentLeft = self.scrollWrapper.css('left')
        currentLeft = parseInt(currentLeft);
        if(currentLeft<0){
            self.scrollWrapper.animate({'left':'0'})
        }else{
            self.scrollWrapper.animate({'left':'-400px'})
        }
    })
}

//定义类的方法
Auth.prototype.showEvent = function () {
    var self = this;
    self.maskWrapper.show();
}


Auth.prototype.hideEvent = function () {
    var self = this;
    self.maskWrapper.hide();
}

//登录方法
Auth.prototype.ListenSigninEvent = function() {
    var signinGroup = $('.signin-group')
    var submitBtn = signinGroup.find('.submit-btn')
    submitBtn.click(function () {
        var telephoneInput = signinGroup.find('input[name="telephone"]');
        var passwordInput = signinGroup.find('input[name="password"]');
        var rememberInput = signinGroup.find('input[name="remember"]')

        var telephone = telephoneInput.val();
        var password = passwordInput.val();
        var remember = rememberInput.val();
        qfajax.post({
            'url': '/account/login/',
            'data':{
                'telephone':telephone,
                'password':password,
                'remember':remember,
            },
            'success':function (result) {
                if (result.code == 200) {
                    alert('登录成功')
                }
            }
        })
    })
}

//注册的方法
Auth.prototype.listenSignupEvent = function () {
    var signupGroup = $('.signup-group')
    var submitBtn = signupGroup.find('.submit-btn')
    submitBtn.click(function () {
        var telephoneInput = signupGroup.find('input[name="telephone"]');
        var usernameInput = signupGroup.find('input[name="username"]');
        // var imageCaptchaInput = signupGroup.find('input[name="img_captcha"]');
        // var smsCaptchaInput = signupGroup.find('input[name="sms_captcha"]');
        var password1Input = signupGroup.find('input[name="password1"]');
        var password2Input = signupGroup.find('input[name="password2"]');


        var telephone = telephoneInput.val();
        var username = usernameInput.val();
        // var imageCaptcha = imageCaptchaInput.val();
        // var smsCaptcha = smsCaptchaInput.val();
        var password1 = password1Input.val();
        var password2 = password2Input.val();

        qfajax.post({
            'url':'/account/register/',
            'data':{
                'telephone':telephone,
                'username':username,
                // 'image_captcha':imageCaptcha,
                'password1':password1,
                'password2':password2,
                // 'sms_captcha':smsCaptcha,
            },
            //result存放服务器返回的结果
            'success':function (result) {
                if(result.code == 200){
                    alert('注册成功')
                }
            }
        })

    })
}

//短信发送成功不再发送
Auth.prototype.ListenSmsSuccessEvent = function() {
    var self = this;
    alert('短信发送成功')
    self.smsCaptcha.addClass('disabled');
    self.smsCaptcha.unbind('click');   // 取消点击事件
    var count = 60;   // 倒计时 时间  一分钟
    var timer = setInterval(function () {
        self.smsCaptcha.text(count+'s');
        count -= 1;
        if(count<=0){
            clearInterval(timer);
            self.smsCaptcha.removeClass('disabled');
            self.smsCaptcha.text('发送验证码');
            seLf.ListenSmsCaptcha();
        }
    },1000)   //1000ms等于1秒

}

//短信验证码方法
Auth.prototype.ListenSmsCaptcha = function() {
    var self = this;
    var smsCaptcha = $('.sms-captcha-btn');   //局部变量
    var telephoneInput = $('.signup-group input[name="telephone"]');
    smsCaptcha.click(function () {
        var telephone = telephoneInput.val()
        if(!telephone){
            alert('请输入手机号')
        }
        qfajax.get({
            'url':'account/sms_captcha/',
            'data': {
                'telephone': telephone,
            },
            'success':function (result) {
                if (result['code'] == 200) {
                    self.ListenSmsSuccessEvent(); //调用发送成功方法
                }
            },
            'fail':function (error) {
                    console.log(error)
             }
        })
    })
}


//run方法 用来执行类的方法
Auth.prototype.run = function () {
    var self = this;
    self.ListenshowHideEvent();
    self.ListenSwitchEvent();
    self.listenSignupEvent();
    self.ListenSigninEvent();
    self.ListenImageCaptchaEvent();
    self.ListenSmsCaptcha();

}

//实例化对象  执行run方法

// $(function () {
//    等页面加载完毕以后我再执行里边的内容
// })

$(function () {
    var auth = new Auth();
    auth.run();
})