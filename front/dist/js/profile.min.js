function Profile() {
    self.progressGroup = $("#progress-group");
     self.progressBar = $(".progress-bar");
}

Profile.prototype.initUeditor = function () {
    window.ue = UE.getEditor('editor', {
            'initialFrameHeight':400,
            'serverUrl':'/ueditor/upload/'
        });
}

Profile.prototype.ListenQiniuUploadFileEvent = function () {
    var self = this;
    var uploadBtn = $('#thumbnail-btn')
    uploadBtn.change(function () {
        var file = this.files[0];//上传的文件名
        qfajax.get({
            'url':'/cms/qntoken/',
            'success':function (result) {
                if(result['code'] == 200){
                    var token = result['data']['token'];
                    //abc.jpg
                    //[abc,jpg]
                    //888.jpg
                    var key = (new Date()).getTime()+'.'+file.name.split('.')[1];
                    var putExtra = {
                        fname: key,
                        params: {},
                        mimeType: ["image/png","image/jpeg","image/gif","video/x-ms-mp4"]
                    };
                    var config = {
                        useCdnDomain: true,
                        retryCount:6,
                        region: qiniu.region.z0   // 华东z0  华北z1  华南z2
                    };
                    var observable = qiniu.upload(file,key,token,putExtra,config);
                    observable.subscribe({
                        'next':self.handleUploadProgress,
                        'complete':self.handleUploadComplete,
                    })
                }
            }
        })
    })
}

Profile.prototype.handleUploadProgress = function(response){
    console.log(response)
    var total = response.total;
    var percent = total.percent;
    var percentText = percent.toFixed(0)+'%';
    var progressGroup = Profile.progressGroup;
    progressGroup.show();
    var progressBar = $('.progress-bar')
    progressBar.css({'width':percentText})
    progressBar.text(percentText)


}

Profile.prototype.handleUploadComplete = function(response){
    console.log(response)
    var progressGroup = Profile.progressGroup;
    progressGroup.hide();
    var domain = "http://qe0l8lesp.bkt.clouddn.com/";
    var url = domain+response.key;
    var thumbnailInput = $("input[name='thumbnail']")
    thumbnailInput.val(url)

}

Profile.prototype.ListenSumbitEvent = function() {
    var submitBtn = $("#submit-btn")
    submitBtn.click(function (event) {
    event.preventDefault();
    var btn = $(this);
    var thumbnail = $("input[name='thumbnail']").val();
    var tel = $("input[name='tel']").val();
    var email = $("input[name='email']").val();
    qfajax.post({
            'url':'/account/profile/',
            'data':{
                'thumbnail':thumbnail,
                'tel':tel,
                'email':email,
            },
            'success':function (result) {
                if(result['code']== 200){
                    xfzalert.alertSuccess('个人资料修改成功',function () {
                        window.location.reload();
                    })
                }
            }
        })
    })
}

Profile.prototype.run = function () {
    var self = this;
    self.initUeditor();
    self.ListenQiniuUploadFileEvent();
    self.ListenSumbitEvent();
}

$(function () {
    var profile = new Profile();
    profile.run();
    Profile.progressGroup = $('#progress-group')
})